// This file has been generated by comet admin-generator.
// You may choose to use this file as scaffold by moving this file out of generated folder and removing this comment.
import { useApolloClient } from "@apollo/client";
import { FinalForm, FinalFormSubmitEvent, TextField, useFormApiRef, useStackSwitchApi } from "@comet/admin";
import { GQLFormBuilderContentScopeInput } from "@src/graphql.generated";
import { FormApi } from "final-form";
import isEqual from "lodash.isequal";
import React from "react";
import { FormattedMessage } from "react-intl";

import { createFormBuilderMutation } from "./FormBuilderAddForm.gql";
import {
    GQLCreateFormBuilderMutation,
    GQLCreateFormBuilderMutationVariables,
    GQLFormBuilderAddFormFragment,
} from "./FormBuilderAddForm.gql.generated";

type FormValues = GQLFormBuilderAddFormFragment;

interface FormProps {
    scope: GQLFormBuilderContentScopeInput;
}

export function FormBuilderAddForm({ scope }: FormProps): React.ReactElement {
    const client = useApolloClient();

    const formApiRef = useFormApiRef<FormValues>();
    const stackSwitchApi = useStackSwitchApi();

    const initialValues = {};

    const handleSubmit = async (formValues: FormValues, form: FormApi<FormValues>, event: FinalFormSubmitEvent) => {
        const output = {
            blocks: { blocks: [] }, // TODO: This line has been added manually, the generator needs to be able to add this.
            ...formValues,
        };

        const { data: mutationResponse } = await client.mutate<GQLCreateFormBuilderMutation, GQLCreateFormBuilderMutationVariables>({
            mutation: createFormBuilderMutation,
            variables: { input: output, scope },
        });
        if (!event.navigatingBack) {
            const id = mutationResponse?.createFormBuilder.id;
            if (id) {
                setTimeout(() => {
                    stackSwitchApi.activatePage(`edit`, id);
                });
            }
        }
    };

    return (
        <FinalForm<FormValues>
            apiRef={formApiRef}
            onSubmit={handleSubmit}
            mode="add"
            initialValues={initialValues}
            initialValuesEqual={isEqual} //required to compare block data correctly
            subscription={{}}
        >
            {() => (
                <>
                    <TextField
                        required
                        variant="horizontal"
                        fullWidth
                        name="name"
                        label={<FormattedMessage id="formBuilder.name" defaultMessage="Name" />}
                    />

                    <TextField
                        variant="horizontal"
                        fullWidth
                        name="submitButtonText"
                        label={<FormattedMessage id="formBuilder.submitButtonText" defaultMessage="Submit button text" />}
                    />
                </>
            )}
        </FinalForm>
    );
}
