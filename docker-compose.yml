services:
    postgres:
        image: postgres:16
        pull_policy: weekly
        tty: true
        volumes:
            - postgres:/var/lib/postgresql/data
        ports:
            - "127.0.0.1:${POSTGRESQL_PORT}:5432"
        environment:
            POSTGRES_USER: ${POSTGRESQL_USER}
            POSTGRES_PASSWORD: ${POSTGRESQL_PWD_DECODED}
            POSTGRES_DB: ${POSTGRESQL_DB}
        networks:
            - postgres

    imgproxy:
        image: darthsim/imgproxy:v3
        pull_policy: weekly
        volumes:
            - ./demo/uploads:/uploads:ro
        ports:
            - "127.0.0.1:${IMGPROXY_PORT}:8080"
        environment:
            IMGPROXY_KEY: ${IMGPROXY_KEY}
            IMGPROXY_SALT: ${IMGPROXY_SALT}
            IMGPROXY_MAX_SRC_RESOLUTION: 70
            IMGPROXY_LOCAL_FILESYSTEM_ROOT: "/uploads"
            IMGPROXY_USE_ABS: ${IMGPROXY_USE_ABS}
            IMGPROXY_ABS_NAME: ${AZURE_ACCOUNT_NAME}
            IMGPROXY_ABS_KEY: ${AZURE_ACCOUNT_KEY}
            IMGPROXY_USE_S3: ${IMGPROXY_USE_S3}
            IMGPROXY_S3_REGION: ${S3_REGION}
            IMGPROXY_S3_ENDPOINT: ${S3_ENDPOINT}
            AWS_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
            AWS_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}

    jaeger:
        image: jaegertracing/all-in-one:1
        pull_policy: weekly
        ports:
            - "127.0.0.1:${JAEGER_UI_PORT}:16686"
            - "127.0.0.1:${JAEGER_OLTP_PORT}:4318" #OLTP over HTTP
        environment:
            COLLECTOR_OTLP_ENABLED: "true"
            COLLECTOR_OTLP_HTTP_HOST_PORT: 0.0.0.0:4318

    redis:
        image: redis:7
        pull_policy: weekly
        command: redis-server --maxmemory 256M --maxmemory-policy allkeys-lru --loglevel warning --requirepass ${REDIS_PASSWORD}
        ports:
            - "127.0.0.1:${REDIS_PORT}:6379"
        networks:
            - redis

    mailhog:
        image: mailhog/mailhog
        pull_policy: weekly
        ports:
            - "127.0.0.1:1025:1025"
            - "127.0.0.1:8025:8025"

    oauth2-proxy:
        image: quay.io/oauth2-proxy/oauth2-proxy:latest
        pull_policy: weekly
        ports:
            - "127.0.0.1:${AUTHPROXY_PORT}:4180"
        restart: on-failure
        extra_hosts:
            - "host.docker.internal:host-gateway"
        environment:
            OAUTH2_PROXY_SKIP_OIDC_DISCOVERY: true
            OAUTH2_PROXY_OIDC_ISSUER_URL: http://localhost:$IDP_PORT
            OAUTH2_PROXY_LOGIN_URL: http://localhost:$IDP_PORT/auth
            OAUTH2_PROXY_OIDC_JWKS_URL: http://host.docker.internal:$IDP_PORT/jwks
            OAUTH2_PROXY_VALIDATE_URL: http://host.docker.internal:$IDP_PORT/token
            OAUTH2_PROXY_REDEEM_URL: http://host.docker.internal:$IDP_PORT/token
            OAUTH2_PROXY_PROFILE_URL: http://host.docker.internal:$IDP_PORT/me
            OAUTH2_PROXY_CLIENT_ID: $IDP_CLIENT_ID
            OAUTH2_PROXY_CLIENT_SECRET: $IDP_CLIENT_SECRET
            OAUTH2_PROXY_UPSTREAMS: http://host.docker.internal:$ADMIN_PORT,http://host.docker.internal:$API_PORT/api/
            OAUTH2_PROXY_REDIRECT_URL: ${ADMIN_URL}/oauth2/callback
            OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
            OAUTH2_PROXY_PROVIDER: oidc
            OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: true
            OAUTH2_PROXY_EMAIL_DOMAINS: "*"
            OAUTH2_PROXY_SCOPE: openid offline_access email profile
            OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER: true
            OAUTH2_PROXY_COOKIE_SECRET: 1234567890123456
            OAUTH2_PROXY_COOKIE_REFRESH: 55m
            OAUTH2_PROXY_COOKIE_SECURE: false
            OAUTH2_PROXY_SHOW_DEBUG_ON_ERROR: true
            OAUTH2_PROXY_API_ROUTES: /api
            OAUTH2_PROXY_CODE_CHALLENGE_METHOD: S256

networks:
    postgres:
        driver: bridge
    redis:
        driver: bridge

volumes:
    postgres:
        driver: local
