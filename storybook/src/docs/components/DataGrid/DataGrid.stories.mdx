import { Meta, Canvas, Story } from "@storybook/addon-docs";

<Meta title="Docs/Components/DataGrid" />

# DataGrid

Comet Admin contains various helpers for using MUI X DataGrid. It works with the MIT or the commercial version.

## Hooks

### useDataGridRemote

Returns props for DataGrid that turns it into a controlled component ready to be used for remote filter/sorting/paging.

Stores state in the url as query parameters.

It's up to the application code to pass filterModel, sortModel and page/pageSize to the remote API.

#### Arguments

| Name              | Type   | Description                                                                      |
| :---------------- | :----- | :------------------------------------------------------------------------------- |
| pageSize          | number | Number of items per page, defaults to 20.                                        |
| queryParamsPrefix | string | Prefix used for query parameters, useful when multiple DataGrid are on one page. |
| initialSort       | Array<{ field: string; sort: GridSortDirection }> | Initial sort columns and directions. Used when no sort query params are present. |
| initialFilter       | GridFilterModel | Initial grid filter. Used when no filter query params are present. |

#### Example

<Canvas>
    <Story id="stories-components-datagrid--usedatagridremote" />
</Canvas>

#### Example Initial Sort

<Canvas>
    <Story id="stories-components-datagrid--usedatagridremoteinitialsort" />
</Canvas>

#### Example Initial Filter

<Canvas>
    <Story id="stories-components-datagrid--usedatagridremoteinitialfilter" />
</Canvas>

## usePersistentColumnState

Returns props for DataGrid that persists all column states into localStorage, DataGrid will have a controlled state for those.

Supported states:

-   columnVisibility
-   pinnedColumns (MUI X Pro feature)
-   columnDimensions (MUI X Pro feature)
-   columnOrder (MUI X Pro feature)

#### Arguments

| Name                  | Type                                                                                         | Description                                                     |
| :-------------------- | :------------------------------------------------------------------------------------------- | :-------------------------------------------------------------- |
| stateKey\*            | string                                                                                       | Unique String used as prefix in localStorage.                   |
| compactViewBreakpoint | [breakpoint key](https://mui.com/material-ui/customization/breakpoints/#default-breakpoints) | Breakpoint below which the compact view is used, if configured. |

#### Example

<Canvas>
    <Story id="stories-components-datagrid--usepersistentcolumnstate" />
</Canvas>

### Optional compact grid view

When using `DataGridPro` with `usePersistentColumnState`, you can enable a compact view of your DataGrid for smaller screens.

This can be done by defining additional columns that show a combination of others.
Then, you can use the `showOnlyInView` setting on certain columns to show them only in the default or compact view.
When defining the columns, use the `GridColDef` type from `@comet/admin` instead of `@mui/x-data-grid`.

By default, the compact view will be shown below the `md` breakpoint of `900px`. The breakpoint can be changed using the `compactViewBreakpoint` argument.

#### Example

In this example, the `First name` and `Last name` columns are shown only in the default view.
In the compact view, the `Full name` column is shown instead.
Since the `ID` column has no `showOnlyInView` setting, it will always be shown.

<Canvas>
    <Story id="stories-components-datagrid--compactview" />
</Canvas>

## useBufferedRowCount

Small hook that can be used to prevent rowCount from being undefined during the loading.

```
const rowCount = useBufferedRowCount(data?.products.totalCount);
```

## GridFilterButton

Small Component that can be placed in the Toolbar that will show the Filter. Must be used as DataGrid child as shown in the story below.

<Canvas>
    <Story id="stories-components-datagrid--gridfilterbutton" />
</Canvas>

## CrudContextMenu

Component that can be rendered as ContextMenu in a row that has some basic CRUD features:

-   `url: string`: Shows a "Copy Url" Menu Item that copies the given Url into the clipboard
-   `copyData: () => Promise<CopyData> | CopyData;`: Shows a "Copy" Menu Item, should return JSON representation of the row
-   `onPaste: (options: { input: CopyData; client: ApolloClient<object> }) => Promise<void>;`: Shows as "Paste" Menu Item, implementation should insert a new row based on the passed `input` JSON. Attention: `input` is not validated.
-   `onDelete: (options: { client: ApolloClient<object> }) => Promise<void>;`: Shows a "Delete" Menu Item, implementation should delete the row.
-   `refetchQueries: RefetchQueriesOptions<any, unknown>["include"];`: called on apollo after executing delete or paste

<Canvas>
    <Story id="stories-components-datagrid--crudcontextmenu" />
</Canvas>

## DataGrid to Comet Graphl API Converter

Comet Admin comes with three helpers that convert MUI DataGrid state to standard Comet GraphQL API variables.

-   `muiGridFilterToGql`
-   `muiGridSortToGql`
-   `muiGridPagingToGql`

Typical Usage Example:

```
const dataGridProps = { ...useDataGridRemote(), ...usePersistentColumnState("ProductsGrid") };
const sortModel = dataGridProps.sortModel;
const { data, loading, error } = useQuery<GQLProductsListQuery, GQLProductsListQueryVariables>(productsQuery, {
    variables: {
        ...muiGridFilterToGql(columns, dataGridProps.filterModel),
        ...muiGridPagingToGql({ page: dataGridProps.page, pageSize: dataGridProps.pageSize }),
        sort: muiGridSortToGql(sortModel),
    },
});

```
