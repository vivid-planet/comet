@AGENTS.md

# Comet Monorepo

Comet is a full-stack CMS and admin framework built with TypeScript. This is a pnpm workspace monorepo containing publishable packages, demo applications, documentation, and a Storybook.

## Repository Structure

```
packages/           # Publishable @comet/* packages
  admin/            # Admin UI packages (React + MUI)
  api/              # Backend API packages (NestJS + GraphQL)
  site/             # Frontend site packages (React, Next.js)
  cli/              # CLI tools
  eslint-config/    # Shared ESLint configurations
  eslint-plugin/    # Custom ESLint rules
  mail-react/       # Email templating with MJML
demo/               # Demo applications
  admin/            # Vite-based admin demo
  api/              # NestJS API demo
  site/             # Next.js site demo
docs/               # Docusaurus documentation site
storybook/          # Storybook component documentation
codemods/           # Automated migration scripts
.changeset/         # Changesets versioning config
```

### Packages Overview

**Admin** (`packages/admin/`):
- `@comet/admin` — Core admin UI framework (React, MUI, Final Form, Apollo GraphQL)
- `@comet/admin-generator` — Generates admin UI code from GraphQL schemas
- `@comet/admin-icons` — Icon library
- `@comet/admin-date-time` — Date/time picker components
- `@comet/admin-rte` — Rich Text Editor (Draft.js)
- `@comet/admin-color-picker` — Color picker component
- `@comet/admin-babel-preset` — Babel preset for admin packages
- `@comet/cms-admin` — CMS-specific admin components
- `@comet/brevo-admin` — Brevo email marketing admin integration

**API** (`packages/api/`):
- `@comet/cms-api` — CMS API framework (NestJS, GraphQL, MikroORM, PostgreSQL)
- `@comet/api-generator` — Generates API code from schemas
- `@comet/brevo-api` — Brevo email marketing API integration

**Site** (`packages/site/`):
- `@comet/site-react` — React library for Comet-powered sites
- `@comet/site-nextjs` — Next.js utilities for Comet sites

**Utilities**:
- `@comet/cli` — Project management CLI
- `@comet/eslint-config` — Shared ESLint configs (core, React, Next.js, NestJS)
- `@comet/eslint-plugin` — Custom ESLint rules
- `@comet/mail-react` — React email utilities with MJML

## Tech Stack

- **Runtime**: Node.js 24, pnpm 10.17.0
- **Language**: TypeScript 5.9
- **Frontend**: React, MUI 7, Apollo Client, Final Form, Vite
- **Backend**: NestJS 11, GraphQL, MikroORM 6, PostgreSQL
- **Site**: Next.js 14
- **Testing**: Vitest (admin packages), Jest (API/site packages)
- **Linting**: ESLint 9 (flat config), Prettier
- **Docs**: Docusaurus, Storybook 9

## Development Commands

### Building

```bash
# Build all publishable packages
pnpm run build:packages

# Build specific package(s)
pnpm --recursive --filter '<package-name>' run build
```

### Running the Demo

```bash
# Start full demo (admin + API + site)
pnpm run dev:demo

# Start individual demo services
pnpm exec dev-pm start @demo-api @demo-admin @demo-site
```

The demo requires Docker services (PostgreSQL, imgproxy, Valkey/Redis) configured via the root `.env` file.

### Other Dev Servers

```bash
pnpm run dev:admin       # Admin packages in watch mode
pnpm run dev:cms         # CMS packages
pnpm run dev:mail-react  # Mail packages
pnpm run dev:brevo       # Brevo packages
pnpm run storybook       # Storybook on port 26638
pnpm run dev:docs        # Documentation site
```

### Linting

```bash
# Full lint (ESLint + Prettier + TypeScript + Knip)
pnpm run lint

# Lint a specific package with autofix
cd packages/<package-path>
pnpm run lint:eslint --fix

# Type-check only
pnpm run lint:tsc
```

- ESLint enforces zero warnings (`--max-warnings 0`).
- Prettier: 150 char print width, 4 space indent, trailing commas, semicolons.

### Testing

```bash
# Run all tests
pnpm run test

# Run tests in a specific package
cd packages/<package-path>
pnpm run test
```

### Code Generation

The demo `admin/` and `api/` directories contain `generated/` folders. Never edit generated files directly — rerun the generators instead:
- `api-generator` for API code
- `admin-generator` for admin code
- GraphQL types are generated via codegen scripts in individual packages

## Changesets and Versioning

All `@comet/*` packages are versioned together (fixed group). Use Changesets for tracking changes:

```bash
pnpm changeset
```

- Create a changeset for user-facing or package changes (not docs-only or internal-only).
- `CHANGELOG.md` files are autogenerated — do not edit them manually.
- Demo apps, storybook, and docs are excluded from releases.

## Commit Conventions

- Do **not** use Conventional Commits (no `feat:`, `fix:` prefixes).
- If a change is scoped to one package, prefix the commit message with the package name (e.g., `@comet/admin: Fix table sorting`).

## Pre-commit Hooks

Husky runs `lint-staged` on commit, which applies ESLint and Prettier to changed files.

## CI/CD

GitHub Actions workflows:
- **lint.yml** — ESLint, Prettier, TypeScript checks, generated file validation
- **test.yml** — Builds packages, runs tests, uploads junit results
- **release.yml** — Changesets-based npm publishing on main
- **chromatic.yml** — Visual regression testing for Storybook
- **peer-deps-check.yml** — Validates peer dependency resolution

## Key Conventions

1. **Linting before committing**: Run `pnpm run lint:eslint --fix` in the affected package directory.
2. **No editing generated files**: `demo/api/generated/` and `demo/admin/generated/` are generated — rerun generators to update.
3. **Build after changes**: After modifying a package, rebuild it with `pnpm --recursive --filter '<package-name>' run build` before testing consumers.
4. **Changeset required**: Add a changeset for any user-facing package change.
5. **Strict peer dependencies**: The workspace enforces `strictPeerDependencies: true`.
6. **ESLint flat config**: All packages use ESLint v9 flat config format (`eslint.config.mjs`).
