self.addEventListener("message", function (event) {
    self.accessToken = event.data;
});

self.addEventListener("activate", function(event) {
    return self.clients.claim();
});

self.addEventListener("fetch", (event) => {
    if (!self.accessToken) return;
    const url = event.request.url;
    if (!url.startsWith("<%= API_URL %>/dam/files/preview/") && !url.startsWith("<%= API_URL %>/dam/images/preview/")) return;

    event.respondWith(
        fetch(event.request, {
            mode: "cors",
            credentials: "include",
            headers: {
                Authorization: `Bearer ${self.accessToken}`,
            },
        }),
    );
});
